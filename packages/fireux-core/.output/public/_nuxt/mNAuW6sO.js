import{E as U,e as I,z as w,p as y,Q as $,R as D,m as _}from"./BVTICooV.js";import{u as S}from"./BD8ciVsq.js";import{u as b}from"./BC6Im6_J.js";async function C(){var d;const n=new Date().toISOString(),a=U(),{appId:u}=I(),s={id:"",name:"",description:"",content:"",active:!0,prices:[],created_at:n,updated_at:n,slug:"",creator_id:((d=a.value)==null?void 0:d.uid)||"",appId:u,stock:null,track_stock:!1,product_type:"physical",default_price:void 0},e=S("createProduct",s),l=S("createProductMainImageData",""),g={buildSlugIfUnique:async(c,P,m)=>({success:!0,slug:`${m}-${c}`}),useCreatePricesState:()=>({defaultPrice:w({id:"default-id",unit_amount:1e3,interval:"month"})})},f=g.buildSlugIfUnique,{useCreatePricesState:t}=g,{defaultPrice:p}=t(),{checkUnique:v}=y(),r=w(!1);$(()=>e.value.name,async c=>{if(!c){r.value=!1,e.value.slug="";return}const P=c.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""),m=`${u}-${P}`;e.value.slug=m,r.value=await v("products","slug",m,!0)}),D(()=>{var c;(c=a.value)!=null&&c.uid&&(e.value.creator_id=a.value.uid),u&&(e.value.appId=u)});function i(){var c;e.value={id:"",name:"",description:"",content:"",active:!0,prices:[],created_at:new Date().toISOString(),updated_at:new Date().toISOString(),slug:"",creator_id:((c=a.value)==null?void 0:c.uid)||"",appId:u,stock:null,track_stock:!1,product_type:"physical",default_price:p.value?{id:p.value.id||"",unit_amount:p.value.unit_amount||0,interval:p.value.interval||void 0}:void 0},l.value=""}async function o(){var h,k,E;console.log("ðŸ“¦ [getProductPayload] Starting payload creation..."),console.log("ðŸ“¦ [getProductPayload] Current product state:",e.value);const c=(h=e.value.name)==null?void 0:h.trim();if(!c)throw console.error("âŒ [getProductPayload] Product name is missing"),new Error("âŒ Product name is required.");if(console.log("âœ… [getProductPayload] Product name validated:",c),!e.value.slug)throw console.error("âŒ [getProductPayload] Slug is missing"),new Error("âŒ Slug is required.");console.log("âœ… [getProductPayload] Slug validated:",e.value.slug),console.log("ðŸ” [getProductPayload] Checking slug uniqueness...");const P=await f("products",c,u);if(!P.success)throw console.error("âŒ [getProductPayload] Slug validation failed:",P.message),new Error(`âŒ ${P.message}`);console.log("âœ… [getProductPayload] Slug uniqueness confirmed"),console.log("ðŸ–¼ï¸ [getProductPayload] Main image data length:",((k=l.value)==null?void 0:k.length)||0);const m={name:c,description:e.value.description||"",content:e.value.content||"",active:e.value.active??!0,slug:e.value.slug||"",stock:e.value.stock??null,product_type:e.value.product_type??"physical",track_stock:e.value.track_stock??!1,images:[],main_image:l.value||"",appId:u,creator_id:((E=a.value)==null?void 0:E.uid)||""};return console.log("âœ… [getProductPayload] Payload created successfully:",m),m}return{product:e,mainImageData:l,resetCreateProductState:i,getProductPayload:o,defaultPrice:p,isSlugTaken:r,buildSlugIfUnique:f}}async function q(){const{getProductPayload:n}=await C();async function a(){try{const u=await n(),s=u.main_image,e={...u,main_image:""};console.log("ðŸ“¦ [createProduct] Sending payload:",{product:e,imageDataLength:(s==null?void 0:s.length)||0});const l=await $fetch("/api/stripe/create-product",{method:"POST",body:{product:e,imageData:s}});if(!l.success)throw new Error(l.error||"Server-side product creation failed");return{success:!0,id:l.id}}catch(u){return{success:!1,error:u.message||"Unexpected error occurred."}}}return{createProduct:a}}function F(){const{updateDocument:n}=y();async function a(u,s){if(!u)throw new Error("Product ID is required for update.");await n("products",u,s)}return{updateProduct:a}}function A(){const{deleteDocument:n}=y(),a=U();async function u(s){if(!s)throw new Error("No product slug provided.");if(!a.value)throw new Error("No authenticated user found.");try{const e=await $fetch("/api/stripe/delete-product",{method:"POST",body:{slug:s,userId:a.value.uid}});if(e.success)return console.log("âœ… Product Deleted Successfully"),await n("products",s),!0;throw console.error("âŒ Error Deleting Product:",e.error||"Unknown error"),new Error(e.error||"Unknown error")}catch(e){throw console.error("âŒ Error Deleting Product:",e),e}}return{deleteProduct:u}}function x(){const{uploadImage:n}=b(),{checkUnique:a}=y();async function u(r,i,o){const d=r.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""),c=o?`${o}-${d}`:d;return await a(i,"slug",c,!0)?{success:!1,message:"This slug already exists. Please pick another title"}:{success:!0,slug:c}}async function s(r,i,o){return await n(r,i,o,"main")||""}function e(r,i){return((r??0)/100).toLocaleString(void 0,{style:"currency",currency:i,minimumFractionDigits:2})}const l="/img/placeholder-product.png";function g(r,i,o=500){const d=`${r}-pro`;return{product:{name:`${i} Pro`,description:`Pro subscription for ${i} with premium features`,active:!0,images:[l],prices:[{unit_amount:o,currency:"usd",billing_scheme:"per_unit",type:"recurring",interval:"month",interval_count:1}]},firebaseProduct:{appId:r,slug:d,content:`Premium features for ${i}`,product_type:"subscription",stock:null,track_stock:!1,main_image:l,subscription_type:"pro",is_default_plan:!0,features:["Premium support","Advanced features","Priority access","Extended limits"]}}}async function f(r){var o;const{firestoreFetchCollection:i}=y();try{return((o=(await i("products")).value)==null?void 0:o.filter(c=>c.appId===r&&c.product_type==="subscription"))||[]}catch(d){return console.error("âŒ [getAppSubscriptionProducts] Error:",d),[]}}async function t(r){const{firestoreQueryOneByField:i}=y();try{return await i("products","slug",`${r}-pro`)}catch(o){return console.error("âŒ [getAppProProduct] Error:",o),null}}function p(r,i="pro"){return(r==null?void 0:r.plan)===i&&(r==null?void 0:r.is_pro)===!0}function v(r){return(r==null?void 0:r.features)||["Premium support","Advanced analytics","Priority features","Extended storage"]}return{formatPrice:e,placeholderImage:l,buildSlugIfUnique:u,uploadMainImage:s,checkUnique:a,createAppProProductPayload:g,getAppSubscriptionProducts:f,getAppProProduct:t,hasSubscriptionPlan:p,getSubscriptionFeatures:v}}function O(){const n=S("createProductPrices",[{unit_amount:0,currency:"eur"}]);function a(){n.value.push({unit_amount:0,currency:"eur"})}function u(t){n.value.splice(t,1)}function s(){n.value=[{unit_amount:0,currency:"eur"}]}function e(){s()}const l=_(()=>{if(!n.value.length)throw new Error("âŒ At least one price is required.");return n.value.map((t,p)=>{if(!t.unit_amount||t.unit_amount<=0)throw new Error(`âŒ Price at index ${p} is missing a valid unit_amount.`);if(!t.currency)throw new Error(`âŒ Price at index ${p} is missing a currency.`);return{billing_scheme:t.billing_scheme??"per_unit",currency:t.currency,unit_amount:t.unit_amount,type:t.type??"one_time",interval:t.type==="recurring"?t.interval??"month":void 0,interval_count:t.type==="recurring"?t.interval_count??1:void 0,metadata:t.metadata??{}}})}),g=_(()=>{var t;return((t=n.value[0])==null?void 0:t.unit_amount)??0}),f=_(()=>{const t=n.value[0];if(t)return{id:t.id??"",unit_amount:t.unit_amount??0,interval:t.interval}});return{prices:n,addPrice:a,removePrice:u,resetPrices:s,resetCreatePricesState:e,pricesPayload:l,defaultUnitPrice:g,defaultPrice:f}}async function z(){const{firestoreFetchCollection:n,firestoreFetchDoc:a,firestoreQueryOneByField:u,firestoreFetchSubcollection:s}=y(),e=await n("products")||w([]);if(e.value)for(const o of e.value){const d=await t(o.slug||"");o.prices=d}async function l(o){return await a("products",o)}function g(o){return u("products","slug",o)}const f="EUR";async function t(o){if(!o)return[];try{return await s("products",o,"prices")}catch(d){return console.error("Error fetching prices:",d),[]}}const p=await q(),v=F(),r=A(),i=x();return{defaultCurrency:f,productsCollection:e,fetchProduct:l,fetchProductBySlug:g,fetchProductPrices:t,useCreateProductState:C,useCreatePricesState:O,...p,...v,...r,...i}}export{z as u};
